<?php
// Filename: /mnt/d/__PROJECTS__/LARAVEL/advanced-todo-app/src/models/Task.php

class Task {
    private $conn;

    public function __construct($db) {
        $this->conn = $db;
    }

    /**
     * Helper: execute statement with params and log errors for debugging.
     */
    private function execStmt(\PDOStatement $stmt, string $sql, array $params = []) {
        try {
            return $stmt->execute($params);
        } catch (\PDOException $e) {
            error_log("[DB EXCEPTION] " . $e->getMessage() . " | SQL: " . $sql . " | PARAMS: " . json_encode($params));
            throw $e;
        }
    }

    /**
     * Create a new task for a specific user
     */
    public function create($data, $user_id) {
        $sql = "INSERT INTO tasks (user_id, title, description, category, priority, due_date, tags) 
                VALUES (:user_id, :title, :description, :category, :priority, :due_date, :tags)";
        $stmt = $this->conn->prepare($sql);

        $params = [
            ':user_id' => $user_id,
            ':title' => $data['title'] ?? null,
            ':description' => $data['description'] ?? null,
            ':category' => $data['category'] ?? null,
            ':priority' => $data['priority'] ?? null,
            ':due_date' => $data['due_date'] ?? null,
            ':tags' => $data['tags'] ?? null // TaskService should have JSON-encoded this
        ];

        if ($this->execStmt($stmt, $sql, $params)) {
            return $this->findById($this->conn->lastInsertId());
        }
        return false;
    }

    /**
     * Find all tasks a user can SEE (owned AND shared)
     */
    public function findAllByUserId($user_id) {
        // This query includes the comment_count
        $sql = "
            SELECT DISTINCT 
                t.*, 
                COUNT(DISTINCT tc.id) as comment_count 
            FROM tasks t
            LEFT JOIN task_shares ts ON t.id = ts.task_id
            LEFT JOIN team_members tm ON ts.team_id = tm.team_id
            LEFT JOIN task_comments tc ON tc.task_id = t.id
            WHERE t.deleted_at IS NULL
              AND (t.user_id = :user_id_owner OR tm.user_id = :user_id_member)
            GROUP BY t.id
            ORDER BY t.sort_order ASC, t.created_at DESC
        ";
        
        $stmt = $this->conn->prepare($sql);
        
        $params = [ 
            ':user_id_owner' => $user_id,
            ':user_id_member' => $user_id
        ];
        
        $this->execStmt($stmt, $sql, $params);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    /**
     * Find a single task by its ID (no user check)
     */
    public function findById($task_id) {
        $sql = "SELECT * FROM tasks WHERE id = :task_id AND deleted_at IS NULL";
        $stmt = $this->conn->prepare($sql);
        $params = [ ':task_id' => $task_id ];
        $this->execStmt($stmt, $sql, $params);
        return $stmt->fetch(PDO::FETCH_ASSOC);
    }

    /**
     * Update a task, only if the user owns it
     * --- THIS IS THE CORRECTED FUNCTION ---
     */
    public function update($task_id, $data, $user_id) {
        if (empty($data) || !is_array($data)) return false;

        $fields = [];
        $params = [];
        foreach ($data as $key => $value) {
            // Build SET clause
            $fields[] = "`$key` = :$key";
            // Build params array
            $params[":$key"] = $value;
        }
        $set_clause = implode(', ', $fields);

        $sql = "UPDATE tasks SET $set_clause WHERE id = :task_id AND user_id = :user_id";
        $stmt = $this->conn->prepare($sql);

        // Add the final params
        $params[':task_id'] = $task_id;
        $params[':user_id'] = $user_id;

        // Use the execStmt helper, which correctly passes the $params array
        if ($this->execStmt($stmt, $sql, $params)) {
            return $this->findById($task_id);
        }
        return false;
    }

    /**
     * Soft-delete a task, only if the user owns it
     */
    public function delete($task_id, $user_id) {
        $sql = "UPDATE tasks SET deleted_at = CURRENT_TIMESTAMP WHERE id = :task_id AND user_id = :user_id";
        $stmt = $this->conn->prepare($sql);
        $params = [ ':task_id' => $task_id, ':user_id' => $user_id ];
        return $this->execStmt($stmt, $sql, $params);
    }

    /**
     * Updates the sort_order for multiple tasks
     */
    public function updateSortOrder($ordered_ids, $user_id) {
        if (empty($ordered_ids)) { return true; }

        $case_sql = "SET sort_order = CASE id \n";
        $params = [];
        $i = 0;

        foreach ($ordered_ids as $id) {
            $case_sql .= "WHEN ? THEN ? \n";
            $params[] = $id;
            $params[] = $i;
            $i++;
        }
        $case_sql .= "END";

        $in_placeholders = implode(',', array_fill(0, count($ordered_ids), '?'));

        foreach ($ordered_ids as $id) { $params[] = $id; }
        $params[] = $user_id;

        $sql = "UPDATE tasks $case_sql WHERE id IN ($in_placeholders) AND user_id = ?";
        $stmt = $this->conn->prepare($sql);

        try {
            return $stmt->execute($params);
        } catch (\PDOException $e) {
            error_log("[DB EXCEPTION] updateSortOrder: " . $e->getMessage());
            return false;
        }
    }

    /**
     * Get all teams a task is shared with
     */
    public function getSharedTeams($task_id) {
        $sql = "SELECT t.id, t.team_name, ts.permission 
                FROM task_shares ts
                JOIN teams t ON ts.team_id = t.id
                WHERE ts.task_id = :task_id";
        $stmt = $this->conn->prepare($sql);
        $params = [ ':task_id' => $task_id ];
        $this->execStmt($stmt, $sql, $params);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    /**
     * Share a task with a team
     */
    public function shareWithTeam($task_id, $team_id, $permission, $shared_by_user_id) {
        // This function is correct 
        $sql = "INSERT INTO task_shares (task_id, team_id, permission, shared_by_user_id)
                VALUES (?, ?, ?, ?)
                ON DUPLICATE KEY UPDATE permission = ?";
        $stmt = $this->conn->prepare($sql);
        return $stmt->execute([
            $task_id,
            $team_id,
            $permission,
            $shared_by_user_id,
            $permission
        ]);
    }

    /**
     * Stop sharing a task with a team
     */
    public function unshareFromTeam($task_id, $team_id) {
        $sql = "DELETE FROM task_shares WHERE task_id = :task_id AND team_id = :team_id";
        $stmt = $this->conn->prepare($sql);
        $params = [ ':task_id' => $task_id, ':team_id' => $team_id ];
        return $this->execStmt($stmt, $sql, $params);
    }
}